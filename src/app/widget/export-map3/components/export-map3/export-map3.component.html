<div class="relative overflow-hidden"> 

    <!-- Formulario -->
    <form [formGroup]="exportForm" (ngSubmit)="onSubmit()" class="grid p-fluid">

      <div class="flex flex-column gap-2">
        <p-message
          *ngFor="let m of uiMessages"
          [severity]="m.severity"
          [text]="m.detail || m.summary || ''"
          [life]="m.life"
          [closable]="m.closable"
        ></p-message>
      </div>


      <div class="flex flex-column mt-3 col-12 gap-2">
        <!-- Título -->
        <div class="mt-3 field w-full">
          <p-floatLabel>
            <input
              id="title"
              pInputText
              formControlName="title"
              class="border-round-sm w-full"
              [attr.maxlength]="MAXLEN.title + 10"
              [ngClass]="{ 'p-invalid': campoInvalido('title') }"
              [attr.aria-describedby]="'title-help'"
              [attr.aria-invalid]="campoInvalido('title') ? 'true' : 'false'"
            />
            <label for="title">Título</label>
          </p-floatLabel>

          <small
            id="title-help"
            class="block mt-1"
            [ngClass]="campoInvalido('title') ? 'text-red-500' : 'text-600'">
            {{ campoInvalido('title')
                ? (errorMsg('title') || ('El título debe contener máximo ' + MAXLEN.title + ' caracteres.'))
                : ('Máximo ' + MAXLEN.title + ' caracteres.') }}
          </small>
        </div>

        <!-- Autor -->
        <div class="field w-full">
          <p-floatLabel>
            <input
              id="author"
              pInputText
              formControlName="author"
              class="border-round-sm w-full"
              [attr.maxlength]="MAXLEN.author + 10"
              [ngClass]="{ 'p-invalid': campoInvalido('author') }"
              [attr.aria-describedby]="'author-help'"
              [attr.aria-invalid]="campoInvalido('author') ? 'true' : 'false'"
            />
            <label for="author">Autor</label>
          </p-floatLabel>

          <small
            id="author-help"
            class="block mt-1"
            [ngClass]="campoInvalido('author') ? 'text-red-500' : 'text-600'">
            {{ campoInvalido('author')
                ? (errorMsg('author') || ('El autor debe contener máximo ' + MAXLEN.author + ' caracteres.'))
                : ('Máximo ' + MAXLEN.author + ' caracteres.') }}
          </small>
        </div>

        <!-- Checks -->
        <div class="field formgrid grid">
          <div class="col-12 md:col-6 flex align-items-center">
            <p-checkbox inputId="grid" formControlName="showGrid" binary="true"></p-checkbox>
            <label for="grid" class="ml-2">Mostrar grilla</label>
          </div>
          <div class="col-12 md:col-6 flex align-items-center">
            <p-checkbox inputId="legend" formControlName="includeLegend" binary="true"></p-checkbox>
            <label for="legend" class="ml-2">Incluir leyenda</label>
          </div>
        </div>
      </div>

      <!-- Orientación -->
      <div class="field my-3 col-12">
        <label for="orientation" class="block mb-2">Orientación del papel</label>
        <p-select
          [options]="orientationOptions"
          formControlName="orientation"
          placeholder="Seleccione orientación"
          optionLabel="label"
          optionValue="value"
          class="w-full border-round-sm"
          [ngClass]="{ 'p-invalid': campoInvalido('orientation') }"
        ></p-select>
        <small *ngIf="campoInvalido('orientation')" class="text-red-500 block mt-1">
          Seleccione una orientación para el papel.
        </small>
      </div>

      <!-- Botones -->
      <div class="col-12 flex justify-content-center mt-3 gap-2">
        <p-button
          label="Imprimir"
          type="submit"
          icon="pi pi-print"
          [rounded]="true"
          [raised]="true">
        </p-button>

        <p-button
          label="Borrar descargas"
          icon="pi pi-trash"
          [rounded]="true"
          [raised]="true"
          [disabled]="!canClearDownloads"
          (onClick)="clearDownloads()">
        </p-button>
      </div>
    </form>

    <!-- Resultados -->
    <ng-container *ngIf="printJobs.length; else empty">
      <div *ngFor="let job of printJobs; index as i"
           class="p-3 border-1 surface-border border-round-xl surface-0 shadow-1 w-full mt-3">

        <!-- Fila superior -->
        <div class="flex align-items-center gap-3 min-w-0">
          <span class="font-medium text-800">{{ i + 1 }}.</span>

          <i class="pi pi-file-pdf text-2xl"
             [ngClass]="{
               'text-primary-500': job.status === 'done',
               'text-600': job.status === 'creating',
               'text-red-500': job.status === 'error'
             }"></i>

          <div class="flex-1 min-w-0">
            <ng-container [ngSwitch]="job.status">
              <a *ngSwitchCase="'done'"
                 [href]="job.url"
                 [download]="job.name"
                 target="_blank"
                 class="hover:underline block overflow-hidden white-space-nowrap text-overflow-ellipsis">
                {{ job.name }}
              </a>
              <span *ngSwitchDefault
                    class="block overflow-hidden white-space-nowrap text-overflow-ellipsis text-800">
                {{ job.name }}
              </span>
            </ng-container>
          </div>

          <small class="ml-auto"
                 [ngClass]="{
                   'text-600': job.status === 'creating',
                   'text-green-600': job.status === 'done',
                   'text-red-600': job.status === 'error'
                 }">
            {{ job.status === 'creating' ? 'Creando impresión…' :
               job.status === 'done'     ? 'Listo' :
               job.status === 'error'    ? 'Error' : '' }}
          </small>
        </div>

        <!-- Progreso -->
        <div class="mt-2">
          <p-progressBar
            [value]="job.progress"
            [showValue]="false"
            class="w-full"
            [style.height.px]="10">
          </p-progressBar>
        </div>

        <!-- Error (si aplica) -->
        <p-message *ngIf="job.status === 'error' && job.error"
                   severity="error"
                   class="mt-2"
                   [text]="job.error">
        </p-message>
      </div>
    </ng-container>

    <!-- Vacío → p-message azul -->
    <ng-template #empty>
      <p-message severity="info" class="mt-3"
                 text="Aún no hay impresiones. Usa el botón ‘Imprimir’ para generar la primera.">
      </p-message>
    </ng-template>

    <!-- Contenedor off-screen del mapa -->
    <div
      #hiddenMapContainer
      class="absolute opacity-0 pointer-events-none"
      aria-hidden="true"
      [style.width.px]="0"
      [style.height.px]="0">
    </div>
</div>
